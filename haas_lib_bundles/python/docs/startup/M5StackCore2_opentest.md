# M5StackCore2 快速开始
&emsp;&emsp;
M5StackCore2是开源世界中被开发者普遍使用的开发板，在M5StackCore2开发板上也可以使用Python语言基于HaaS开发框架进行轻应用开发。前提是M5StackCore2开发板中有烧录HaaS开发团队发布的HaaS Python基础固件。

&emsp;&emsp;
本文则主要介绍如何烧录M5Stack HaaS标准固件并在此基础上完成helloworld Python程序的运行。

## M5StackCore2 HaaS固件下载

&emsp;&emsp;
请通过下面固件列表链接下载开发板对应的固件压缩包并解压，解压完成后可以看到其目录结构如下：
```
├── HaaSPython-ESP32-8M-{xxx}.bin   # HaaS官方固件，{xxx}为版本号
```
&emsp;&emsp;
### HaaS Python M5StackCore2标准固件列表
* [HaaSPython-ESP32-8M-v1.0.3](https://hli.aliyuncs.com/o/config/HaaS_Python/HaaSPython-ESP32-8M-opentest.zip)
  * 版本更新说明（2021-01-13)
    * 新增HaaS AI能力
    * 新增HaaS UI Lite能力

## M5StackCore2开发环境准备
&emsp;&emsp;
将M5StackCore2开发板用USB Type-C数据线和电脑USB口相连。

### HaaS Studio安装
&emsp;&emsp;
HaaS Studio目前是以插件的形式安装在VS Code（Visual Studio Code）工具中，所以安装HaaS Studio之前需要先安装VS Code。

#### 安装VS Code

&emsp;&emsp;
读者请到[微软官方网站](https://code.visualstudio.com/)上下载 VS Code 安装包并进行安装，VS Code安装包要求不低于版本 1.57。

&emsp;&emsp;
VS Code安装包下载网站： https://code.visualstudio.com/

> 推荐 Windows 系统版本为 win10， MacOS 版本不低于 10.15。
<br>

#### 安装haas-studio插件

&emsp;&emsp;
安装完 VS Code之后，请按照下图中数字的指示步骤完成haas-studio插件的安装。

<div align="center">
<img src=../images/1_安装haas_studio_插件.png width=80%/>
</div>

&emsp;&emsp;
插件安装完成后，则 VS Code 左下角的状态栏会显示"快速开始"的图标，如下图所示。

<div align="center">
<img src=https://hli.aliyuncs.com/haas-static/haasapi/Python/docs/zh-CN/images/1_HaaS_Studio_新建工程按钮.png width=80%/>
</div>

&emsp;&emsp;
如果你已经打开了某个Python工程，则会在VS Code底部的状态栏显示如下一排按钮，这些按钮的功能如下图所示：

<div align="center">
<img src=https://hli.aliyuncs.com/haas-static/haasapi/Python/docs/zh-CN/images/1_HaaS_Studio_Python工程按钮.png width=40%/>
</div>

### M5StackCore2串口名称确认
&emsp;&emsp;
进行下面操作前请务必确认PC和M5StackCore2开发板之间连接用的是USB转Type-C类型的数据线，而非`Type-C的延长线`。`Type-C的延长线会导致电脑没办法正常识别M5StackCore2的串口`。

#### Windows系统

&emsp;&emsp;
如果您的电脑是Windows系统，请通过控制面板下的设备管理器，查询当前电脑下M5StackCore2插入后新增的端口。下图中显示电脑连接M5StackCore2后新增的串口为“COM7”。
> 注意：每台PC的串口可能都不一样，如果有多个串口，可以断开PC和M5StackCore2之间的连线，然后将PC和M5StackCore2相连，找到新增的那个串口。

<div align="center">
<img src=https://hli.aliyuncs.com/haas-static/haasapi/Python/docs/zh-CN/images/1_HaaS_EDU_K1_WINDOWS_COM.png width=70%/>
</div>

&emsp;&emsp;
如果电脑在连接M5StackCore2之前和之后，没有新增串口，则需要安装M5StackCore2的串口驱动：[驱动下载链接](https://docs.m5stack.com/en/download)。

<div align="center">
<img src=https://hli.aliyuncs.com/haas-static/haasapi/Python/docs/zh-CN/images/M5StackCore2驱动下载页_Windows.png width=70%/>
</div>

<br>

#### MAC系统

&emsp;&emsp;
使用MAC系统的开发者`务必`下载MACOS的驱动并`严格按照驱动压缩包中的pdf说明文档`中的安装说明进行安装（MAC下驱动加载需要手动开启加载权限）。
<div align="center">
<img src=https://hli.aliyuncs.com/haas-static/haasapi/Python/docs/zh-CN/images/M5StackCore2驱动下载页_MACOS.png width=70%/>
</div>

> 笔者下的v1.7版本的驱动解压后说明文档名称为“CH34X_DRV_INSTALL_INSTRUCTIONS.pdf”如下图所示：

<div align="center">
<img src=https://hli.aliyuncs.com/haas-static/haasapi/Python/docs/zh-CN/images/M5StackCore2驱动下载页_MACOS_说明文档.png width=70%/>
</div>

<br>
&emsp;&emsp;
驱动安装完成后，可以在命令行中通过如下命令查看M5StackCore2接到电脑之前和之后串口列表的差异确认M5StackCore2串口名称。

```
# 接入M5StackCore2之前
(base) ➜  ~ ls /dev/tty.wchusbserial*
zsh: no matches found: /dev/tty.wchusbserial*

# 接入M5StackCore2之后
(base) ➜  ~ ls /dev/tty.wchusbserial*
/dev/tty.wchusbserial51850052081
```

&emsp;&emsp;
如果你的电脑在插入M5StackCore2之后出现名称为tty.wchusbserial<xxx>的串口则代表驱动安装成功了。如果电脑只识别到一个名为tty.usbmodem<xxxx>的串口，则代表驱动未安装成功，请寻求M5StackCore2官方旗舰店的客服的协助。
> 注意：每台PC的串口可能都不一样，上面只是笔者电脑上面的串口信息。

### 固件烧录过程
&emsp;&emsp;
烧录此固件需使用HaaS-Studio集成开发环境。

1. 点击“快速开始”按钮后选择“烧录工具”按钮。如下图所示。
<div align="center">
<img src=https://hli.aliyuncs.com/haas-static/haasapi/Python/docs/zh-CN/images/1_HaaS_Studio_固件烧录.png width=75%/>
</div>
1. 选择好M5StackCore2对应的“串口名字”和固件所在路径（上面“M5StackCore2 HaaS固件下载”步骤中解压出来的名为HaaSPython-ESP32-8M-{xxx}.bin的文件）之后点击“开始烧录”按钮，HaaS Studio便会将此固件烧录到开发板中，如下图所示。

> 下图中是笔者电脑中的串口好和固件名称，请读者按照根据串口和固件实际路径进行选择。

> 如果“串口名字”下拉框中没有正确的串口号，可以拔插M5StackCore2的USB口后，点击“刷新”按钮刷新串口列表。

<div align="center">
<img src=https://hli.aliyuncs.com/haas-static/haasapi/Python/docs/zh-CN/images/1_HaaS_Studio_固件烧录_开始烧录.png width=85%/>
</div>

&emsp;&emsp;
烧录过程中命令行窗口会输出如下日志，烧录完成，终端日志中会提示"Hash of data verified."。

```
Serial port /dev/tty.usbserial-1410
Connecting.......
Detecting chip type... Unsupported detection protocol, switching and trying again...
Connecting....
Detecting chip type... ESP32
Chip is ESP32-D0WD (revision 1)
Features: WiFi, BT, Dual Core, 240MHz, VRef calibration in efuse, Coding Scheme None
Crystal is 40MHz
MAC: 8c:ce:4e:9a:67:ec
Uploading stub...
Running stub...
Stub running...
Changing baud rate to 460800
Changed.
Erasing flash (this may take a while)...
Chip erase completed successfully in 13.0s
Hard resetting via RTS pin...

...
Changing baud rate to 460800
Changed.
Configuring flash size...
Flash will be erased from 0x00001000 to 0x001e3fff...
Compressed 1977072 bytes to 1172201...
Wrote 1977072 bytes (1172201 compressed) at 0x00001000 in 31.0 seconds (effective 511.0 kbit/s)...
Hash of data verified.

Leaving...
Hard resetting via RTS pin...
```

&emsp;&emsp;
经过上面的步骤HaaS Python M5StackCore2固件就烧录到M5StackCore2开发板中去了。

### 固件版本确认
&emsp;&emsp;
固件烧录完成后，如何确认固件真的有更新到硬件中呢？可以通过如下的方法确认：

&emsp;&emsp;
通过串口工具打开M5StackCore2开发板（注意波特率选择115200），此时敲击回车会出现“>>>”符号，">>>"代表已经进入到Python的REPL模式中。在REPL模式中输入“import uos; uos.version_info()”指令回车执行，HaaS Python则会将版本号信息输出到串口中。如下图所示，其版本信息遵循“HaaSPython-ESP32-8M-\<version>-\<buildtime>”的格式，其中：
* \<version\>：代表HaaS Python版本号。
* \<buildtime\>：代表固件编译时间。
> MACOS建议使用picocom串口工具；Windows系统推荐使用Putty串口工具。

<div align="center">
<img src=https://hli.aliyuncs.com/haas-static/haasapi/Python/docs/zh-CN/images/HaaSPython_版本号确认_M5StackCore2.png width=80%/>
</div>

## M5StackCore2 helloworld例程

### 创建helloworld工程
&emsp;&emsp;
请遵循如下的步骤完成helloworld Python工程的创建。

&emsp;&emsp;
如下图所示，点击HaaS Studio的"快速开始"按键会弹出HaaS Studio的欢迎页面，请选择“创建项目”，如下图所示：

<div align="center">
<img src=https://hli.aliyuncs.com/haas-static/haasapi/Python/docs/zh-CN/images/1_HaaS_Studio_创建项目向导.png width=60%/>
</div>

&emsp;&emsp;
根据创建工程向导，开发者输入/选择相关的信息即可。下面以在M5StackCore2上面创建hellworld示例程序为例演示工程进行，步骤如下:
> 注意事项： 文件夹不要有中文，空格及其他异常字符。

1. 输入项目名称
2. 选择工作区所在路径
3. 选择硬件类型
4. 选择编程语言
5. 选择解决方案模板
<div align="center">
<img src=https://hli.aliyuncs.com/haas-static/haasapi/Python/docs/zh-CN/images/1_HaaS_Studio_Python创建工程_项目名称_m5stackcore2.png width=40%/>
</div>

&emsp;&emsp;
然后点击“立即创建”按钮，在随后的步骤中确认输入的信息无误，点击“确认”，等待工程创建完成后，VS Code会自动打开新创建的工程。就可以在左侧的文件浏览页面中看到刚刚创建的helloworld工程。

### 推送脚本到设备

&emsp;&emsp;
点击HaaS-Studio的“部署运行”按钮（<img src=https://hli.aliyuncs.com/haas-static/haasapi/Python/docs/zh-CN/images/1_HaaS_Studio_部署运行.png width=5%/>），HaaS-Studio会将脚本推送到开发板上。

&emsp;&emsp;
脚本推送完成后，VS Code的命令行窗口会有如下提示：
```
upload success
```

&emsp;&emsp;
如果`推送不成功`请点击下面"推送失败的解决方案"按钮查看解决方法。
<details>
<summary>推送失败的解决方案</summary>
&emsp;&emsp;
一般情况下，推送失败是因为电脑上外接了多个USB转串口的设备导致的。此时，VS Code的命令行中会列出系统的串口列表，需要您在命令行中敲入M5StackCore2串口名称（前面“M5StackCore2串口名称确认”步骤中有说明）对应的序号之后敲回车。如下图所示：

<div align="center">
<img src=https://hli.aliyuncs.com/haas-static/haasapi/Python/docs/zh-CN/images/1_HaaS_Studio_选择串口序号.png width=150%/>
</div>

&emsp;&emsp;
如果选择了串口仍然推送失败，请联系HaaS小二解决推送问题。

</details>

<br>
&emsp;&emsp;
推送此脚本到M5StackCore2之后，HaaS-Studio同时会自动打开串口工具，并自动执行main.py脚本，此时可以在看到设备周期性的打印如下日志。

```
...
helloworld
helloworld
helloworld
...
```

### 例程Python脚本说明

&emsp;&emsp;
helloworld工程中的main.py脚本内容如下，各行代码的功能请参考下面代码的注释。

```python
#!/usr/bin/env python
# -*- encoding: utf-8 -*-

import utime   # 延时函数在utime库中

if __name__ == '__main__':
    while True:             # 无限循环
        print("helloworld")  # 打印"helloworld"字串到串口中
        utime.sleep(1)      # 打印完之后休眠1秒
```

&emsp;&emsp;
helloworld例程运行起来就说明HaaS Python开发环境安装好了。

# HaaS AI/UI/Audio公测案例说明
&emsp;&emsp;
M5StackCore2快速开始完成之后，公测用户可以开始如下几部分的测试。

## Audio案例
Audio创意案例测试入口：https://haas.iot.aliyun.com/solution
* [播报音箱](https://haas.iot.aliyun.com/solution/detail/solution?versionId=800AF99C5AC00ACE00000001&dataId=800AF99C5AC00ACE)

## HaaS AI案例
&emsp;&emsp;
HaaS AI创意案例测试入口：https://haas.iot.aliyun.com/solution

&emsp;&emsp;
主要有下图中的三个案例：
* [水果识别系统](https://haas.iot.aliyun.com/solution/detail/solution?versionId=800A962AB944E4C400000001&dataId=800A962AB944E4C4)
* [人员入侵检测系统](https://haas.iot.aliyun.com/solution/detail/solution?versionId=800A42D45EC1E0D100000001&dataId=800A42D45EC1E0D1)
* [车牌识别](https://haas.iot.aliyun.com/solution/detail/solution?versionId=800AD0DC054E0B5B00000001&dataId=800AD0DC054E0B5B)

## HaaS UI案例
&emsp;&emsp;
HaaS AI创意案例测试入口：https://haas.iot.aliyun.com/solution

&emsp;&emsp;
主要有下图中的三个案例：
* [温湿度面板](https://haas.iot.aliyun.com/solution/detail/solution?versionId=800AEA703FFFF1A300000001&dataId=800AEA703FFFF1A3)
* [倒计时计数器](https://haas.iot.aliyun.com/solution/detail/solution?versionId=800A1DAF896F599700000001&dataId=800A1DAF896F5997)
* [音乐播放器](https://haas.iot.aliyun.com/solution/detail/solution?versionId=800AE9E2A8B7DCDB00000001&dataId=800AE9E2A8B7DCDB)

## HaaS AI/UI/Audio文档
&emsp;&emsp;
HaaS API文档测试入口：https://haas.iot.aliyun.com/

<div align="center">
<img src=https://hli.aliyuncs.com/haas-static/haasapi/Python/docs/zh-CN/images/HaaS官网_HaaSAPI网页入口.png width=80%/>
</div>

&emsp;&emsp;
进入HaaS API说明文档页之后，请根据您自己想要实现的功能，选择左侧对应的库说明。
> Audio是音频播放的API说明
> HaaSUILite是轻量级显示框架的API说明
> AI是人工智能能力的API说明
> ucamera是摄像头功能的API说明

<div align="center">
<img src=https://hli.aliyuncs.com/haas-static/haasapi/Python/docs/zh-CN/images/HaaSAPI_haasuilite_说明文档.png width=80%/>
</div>

&emsp;&emsp;
在使用过程中如果您有任何疑问（哪怕是一点点的疑问），请直接反馈给我们的HaaS小二。

> 再次感谢您能参与HaaS Python的公测！

<br>
